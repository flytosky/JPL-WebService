<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <!-- <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3/jquery.min.js" type="text/javascript"></script> -->
  <script type="text/javascript" src="js/jquery-1.6.4.min.js"></script>
  <script type="text/javascript" src="js/jquery.flot.min.js"></script>
  <script type="text/javascript" src="js/json2.js"></script>
  <script type="text/javascript" src="js/xmisc.js"></script>
  <script type="text/javascript">

    // for x variable
    var x = null;
    var xMasked = null;
    var xAllowRange = null;
    var xRejectList = null;

    // for y variable
    var y = null;
    var yMasked = null;
    var yAllowRange = null;
    var yRejectList = null;

    // for plot
    var xMin = null;
    var xMax = null;
    var yMin = null;
    var yMax = null;

    var mask_x = function() {
        var z;
        z = xmisc.select_by_range(x, xAllowRange, null, false);
        z = xmisc.select_by_list(z, xRejectList, null, true);
        xMasked = z;
        return true;
    }

    var mask_y = function() {
        var z;
        z = xmisc.select_by_range(y, yAllowRange, null, false);
        z = xmisc.select_by_list(z, yRejectList, null, true);
        yMasked = z;
        return true;
    }

    var myplot = function() {
        var rv = xmisc.get_series(xMasked, yMasked);
        if (rv.error != null) {
            alert(rv.error);
            return;
        }

        var options = {
            xaxis: {
                min: xMin,
                max: xMax
            },
            yaxis: {
                min: yMin,
                max: yMax
            }
        };

        var data = [
            {
                data: rv.data,
                clickable: true,
                lines: { show: false},
                points: { show: true}
            }
        ];

        $.plot($("#content"), data, options);
    };

    var stqResponse = null;
    var samResponse = null;
    var izpdResponse = null;

    $(document).ready(function(){

      $("a").click(function(event){
        alert("As you can see, the link no longer took you to jquery.com");
        event.preventDefault();
      });

      $("#stq").click(function(event) {
	stqResponse = null;
        $("#stqResponse").html("working...");

        var url = $("#stqEndpoint").val();
        var difid = $("#difid").val();
        var t0 = $("#t0").val();
        var t1 = $("#t1").val();
        var lon0 = $("#lon0").val();
        var lon1 = $("#lon1").val();
        var lat0 = $("#lat0").val();
        var lat1 = $("#lat1").val();
        //alert(url);
        var t = [t0, t1];
        // http://surf11.com/entry/157/javascript-isinteger-function
        if (t1.search(/^[0-9]+$/) == 0) {
            t = [t0, parseInt(t1)];
        }
        var lon = [parseFloat(lon0), parseFloat(lon1)]
        var lat = [parseFloat(lat0), parseFloat(lat1)]
        var query = {difid:difid, t:t, lon:lon, lat:lat};
        var text = JSON.stringify(query, null, 4);
        //alert(text);
        url = url + "?" + encodeURIComponent(JSON.stringify(query));
        // alert("url: " + url);
        $.ajax({
            type: "GET",
            url: url,
            //jsonp: "callback",
            //dataType: "jsonp",
            dataType: "json",
            //callback: "hihi",
            data: null,
            success: function(data, textStatus, xhr) {
                stqResponse = data;
                if (data.error) {
                    alert(data.error);
                    stqResponse = null;
                    $("#stqResponse").html("<span style='color:red'>error in backend</span>");
                    return;
                }
                // clone this member, so that it can be reset late,
                // because array assignment is by reference.
                // http://my.opera.com/GreyWyvern/blog/show.dml/1725165
                var urisClone = data.result.uris.slice(0);
                var uris = data.result.uris;
                var prefix = "http://oscar.jpl.nasa.gov";
                for (var i=0; i<uris.length; i++) {
                    var w10nNodeMeta = prefix+uris[i]+"/";
                    uris[i] = "<a href='"+w10nNodeMeta+"?output=html&traverse' target='"+w10nNodeMeta+"'>"+uris[i]+"</a>";
                }
                //alert("success status: "+textStatus);
                var text = JSON.stringify(data, null, 4);
                //alert(text);
                $("#stqResponse").html("<pre>"+text+"</pre>");
                // reset uris back to original
                data.result.uris = urisClone;
            },
            error: function(xhr, textStatus, errorThrown) {
		$("#stqResponse").html("error!");
                alert("error status: "+textStatus);
            },
            complete: function(xhr, textStatus) {
                //alert("complete status: "+textStatus);
            }
        });

      });

      $("#sam").click(function(event) {
	samResponse = null;
        $("#samResponse").html("working ...");

        var url = $("#samEndpoint").val();
        //alert(url);
        if (stqResponse == null) {
            $("#samResponse").html("error!");
            alert("You must do STQ First!");
            return false;
        }

        var lon = stqResponse.query.lon;
        var lat = stqResponse.query.lat;
        var geoRegion = {lon:lon, lat:lat};

        var granules = stqResponse.result.uris;
        if (granules.length == 0) {
            $("#samResponse").html("error!");
            alert("error: no granule!");
            return false;
        }
        var query = {georegion:geoRegion, granules:granules};
        var text = JSON.stringify(query, null, 4);
        //alert(text);
        url = url + "?" + encodeURIComponent(JSON.stringify(query));
        //url = url + "?" + encodeURI(JSON.stringify(query));
        //url = url + "?" + escape(JSON.stringify(query));
        //url = url + "?" + JSON.stringify(query).replace('"', '\"');
        //alert(url);
        $.ajax({
            type: "GET",
            url: url,
            //jsonp: "callback",
            //dataType: "jsonp",
            dataType: "json",
            //callback: "hihi",
            //data: {granules:granules, geoRegion:geoRegion},
            data:null,
            success: function(data, textStatus, xhr) {
		samResponse = data;
                if (data.error) {
                    alert(data.error);
                    samResponse = null;
                    $("#samResponse").html("<span style='color:red'>error in backend</span>");
                    return;
                }
                //alert("success status: "+textStatus);
                var text = JSON.stringify(data, null, 4);
                //alert(text);
                $("#samResponse").html("<pre>"+text+"</pre>");
            },
            error: function(xhr, textStatus, errorThrown) {
                $("#samResponse").html("error!");
                alert("error status: "+textStatus);
            },
            complete: function(xhr, textStatus) {
                //alert("complete status: "+textStatus);
            }
        });

      });

      $("#izpd").click(function(event) {
	izpdResponse = null;
        $("#izpdResponse").html("working ...");
        $("#zpdImage").html("waiting ...");

        var url = $("#izpdEndpoint").val();
        //alert(url);
        if (samResponse == null) {
            $("#izpdResponse").html("error!");
            $("#zpdImage").html("no image");
            alert("You must do SAM First!");
            return false;
        }
        var keyword = "MODIS_NIR";
        var geoRegion = samResponse.query.georegion;
	var uri = samResponse.result.uri;
        if (uri == "") {
            $("#izpdResponse").html("error!");
            $("#zpdImage").html("no image");
            alert("sam has no result!");
            return false;
        }
        var query = {uri:uri, keyword:keyword, georegion:geoRegion};
        var text = JSON.stringify(query, null, 4);
        //alert(text);
        url = url + "?" + encodeURIComponent(JSON.stringify(query));
        //url = url + "?" + encodeURI(JSON.stringify(query));
        //url = url + "?" + escape(JSON.stringify(query));
        //url = url + "?" + JSON.stringify(query).replace('"', '\"');
        //alert(url);
        $.ajax({
            type: "GET",
            url: url,
            //jsonp: "callback",
            //dataType: "jsonp",
            dataType: "json",
            //callback: "hihi",
            //data: {granules:granules, geoRegion:geoRegion},
            data:null,
            success: function(data, textStatus, xhr) {
		izpdResponse = data;
                if (data.error) {
                    alert(data.error);
                    izpdResponse = null;
                    $("#izpdResponse").html("<span style='color:red'>error in backend</span>");
                    return;
                }

                var dataUri = data.result.dataUri;
                var imageUri = data.result.imageUri;
                data.result.dataUri = "<a href='"+dataUri+"'>"+dataUri+"</a>";
                data.result.imageUri = "<a href='"+imageUri+"' target='"+imageUri+"'>"+imageUri+"</a>";
                //alert("success status: "+textStatus);
                var text = JSON.stringify(data, null, 4);
                //alert(text);
                $("#izpdResponse").html("<pre>"+text+"</pre>");
                // reset back
                data.result.dataUri = dataUri;
                data.result.imageUri = imageUri;

		var html = ""
                    //+ "<img src='"+data.result.imageUri+"?"+(new Date()).getTime()+"' width='443' height='516'/>";
                    + "<img src='"+data.result.imageUri+"?"+(new Date()).getTime()+"' width='600'/>";
                //$("#zpdImage").html("<img src='"+data.result.imageUri+"?"+(new Date()).getTime()+"' width='443' height='516'/>");
                $("#zpdImage").html(html);
            },
            error: function(xhr, textStatus, errorThrown) {
                $("#izpdResponse").html("error!");
                $("#zpdImage").html("no image");
                alert("error status: "+textStatus);
            },
            complete: function(xhr, textStatus) {
                //alert("complete status: "+textStatus);
            }
        });

      });

      $("#xAxis").change(function(event) {
        //alert(this.value);
        //$("#content").html(this.value);
        var url = this.value;
        $.ajax({
            type: "GET",
            url: this.value,
            //url: url,
            jsonp: "callback",
            dataType: "jsonp",
            //callback: "hihi",
            data: {output:"json", flatten:""},
            success: function(data, textStatus, xhr) {
                //alert("success status: "+textStatus);
                //alert(data.w10n[2].name);
                x = data.data;
                mask_x();
                myplot();
            },
            error: function(xhr, textStatus, errorThrown) {
                alert("error status: "+textStatus);
            },
            complete: function(xhr, textStatus) {
                alert("complete status: "+textStatus);
            }
        }
        );
      });

      $("#yAxis").change(function(event) {
        $.ajax({
            type: "GET",
            url: this.value,
            jsonp: "callback",
            dataType: "jsonp",
            data: {output:"json", flatten:""},
            success: function(data, textStatus, xhr) {
                //alert("success status: "+textStatus);
                //alert(data.w10n[3].name);
                y = data.data;
                mask_y();
                myplot();
            },
            //error: function(xhr, textStatus, errorThrown) {
            //    alert("error status: "+textStatus);
            //},
            complete: function(xhr, textStatus) {
                alert("complete status: "+textStatus);
            }
        }
        );
      });

      $("#xAllowRange").change(function(event) {
            if (!x)
                return true;
            xAllowRange = this.value.split(/s*[\s,]\s*/, 2);
            if (xAllowRange.length != 2) {
                alert("Wrong format for xAllowRange: "+this.value);
                xAllowRange = null;
                return false;
            }
            mask_x();
            myplot();
            return true;
      });

      $("#yAllowRange").change(function(event) {
            if (!y)
                return true;
            yAllowRange = this.value.split(/s*[\s,]\s*/, 2);
            if (yAllowRange.length != 2) {
                alert("Wrong format for yAllowRange: "+this.value);
                yAllowRange = null;
                return false;
            }
            mask_y();
            myplot();
            return true;
      });

      $("#xRange").change(function(event) {
            xMin = null;
            xMax = null;
            var tmp = this.value.split(/s*[\s,]\s*/, 2);
            if (tmp.length > 0)
                xMin = tmp[0];
            if (tmp.length > 1)
                xMax = tmp[1];
            myplot();
      });

      $("#yRange").change(function(event) {
            yMin = null;
            yMax = null;
            var tmp = this.value.split(/s*[\s,]\s*/, 2);
            if (tmp.length > 0)
                yMin = tmp[0];
            if (tmp.length > 1)
                yMax = tmp[1];
            myplot();
      });

    });
    
  </script>
</head>
<body>

<p>

<table border="1">

<tr>
<td colspan="4">
<center>
<b>Service: 3-D Variable Slice Map</b>
</center>
</td>
</tr>

<tr>
<td>data source:</td><td><select name=id>
<option>CCCMA/CANESM2</option>
<option>GFDL/CM3</option>
<option>GISS/E2-R</option>
<option>NCAR/CAM5</option>
<option>UKMO/HadGEM2-ES</option>
<option>NASA/obs4MIPs</option> </select></td>
<td>variable name:</td><td><select name=id>
<option>Surface Temperature</option>
<option>Total Cloud Fraction</option>
<option>Precipitation</option> </select></td>
</tr>

<tr>
<td>start year-month:</td><td><input id="t0" value="2011-03"/></td>
<td>end year-month:</td><td><input id="t1" value="2012-11"/></td>
</tr>

<tr>
<td>select months:</td>
<td><select name=id>
<option>select none</option>
<option>select all</option>
<option>Summer:Jun-Jul-Aug</option>
<option>Autumn:Sep-Oct-Nov</option>
<option>Winter:Dec-Jan-Feb</option>
<option>Spring:Mar-Apr-May</option> </select>
</td>
<td>
</td>
<td>
</tr>

<tr>
<td>
<label><input type="checkbox" name="option1" id="Jan" value="Jan" /> Jan<br></label>
<label><input type="checkbox" name="option1" id="Feb" value="Feb" /> Feb<br></label>
<label><input type="checkbox" name="option1" id="Mar" value="Mar" /> Mar<br></label>
</td>
<td>
<label><input type="checkbox" name="option1" id="Apr" value="Apr" /> Apr<br></label>
<label><input type="checkbox" name="option1" id="May" value="May" /> May<br></label>
<label><input type="checkbox" name="option1" id="Jun" value="Jun" /> Jun<br></label>
</td>
<td>
<label><input type="checkbox" name="option1" id="Jul" value="Jul" /> Jul<br></label>
<label><input type="checkbox" name="option1" id="Aug" value="Aug" /> Aug<br></label>
<label><input type="checkbox" name="option1" id="Sep" value="Sep" /> Sep<br></label>
</td>
<td>
<label><input type="checkbox" name="option1" id="Oct" value="Oct" /> Oct<br></label>
<label><input type="checkbox" name="option1" id="Nov" value="Nov" /> Nov<br></label>
<label><input type="checkbox" name="option1" id="Dec" value="Dec" /> Dec<br></label>
</td>
</tr>

<tr>
<td colspan="2"><input id="2dvarmap" type="submit" value="get service"/></td>
</tr>

</table>

</p>

<p>
<div id="stqResponse">Result of 3D Var Slice Map Service:</div>
</p>

</body>
</html>
